
#createdb -h localhost -T template_postgis minnpost_redistricting_2012

#shp2pgsql -s 4326 -d shapefiles/precincts_pvi_mnleg_060810/vtd_20101029.shp precincts | psql -d minnpost_redistricting_2012
#shp2pgsql -s 4326 -d data/shapefiles/2012_sen/S2012.shp districts_sen_2012 | psql -d minnpost_redistricting_2012

#shp2pgsql -s 4326 -d shapefiles/2010_districts/reprojected/tl_2010_27_sldl10.shp districts_2002 | psql -d minnpost_redistricting_2012
#shp2pgsql -s 4326 -d shapefiles/2012_leg/L2012.shp districts_2012 | psql -d minnpost_redistricting_2012

# In psql ... this checks that using the centroid gives us the correct districts
#SELECT districts_2002.sldlst10, precincts.leg FROM districts_2002 INNER JOIN precincts ON ST_Intersects(districts_2002.the_geom, ST_Centroid(precincts.the_geom));

mkdir -p shapefiles/precincts_pvi_2002
pgsql2shp -f shapefiles/precincts_pvi_2002/precincts_pvi_2002.shp minnpost_redistricting_2012 "SELECT districts_2002.the_geom, districts_2002.sldlst10, precincts.ltr06, precincts.ltd06, precincts.lot06, precincts.ltr08, precincts.ltd08, precincts.lot08 FROM districts_2002 INNER JOIN precincts ON ST_Intersects(districts_2002.the_geom, ST_Centroid(precincts.the_geom));"

mkdir -p shapefiles/precincts_pvi_2012
pgsql2shp -f shapefiles/precincts_pvi_2012/precincts_pvi_2012.shp minnpost_redistricting_2012 "SELECT districts_2012.the_geom, districts_2012.district, precincts.ltr06, precincts.ltd06, precincts.lot06, precincts.ltr08, precincts.ltd08, precincts.lot08, precincts.ltr10, precincts.ltd10, precincts.lot10 FROM districts_2012 INNER JOIN precincts ON ST_Intersects(districts_2012.the_geom, ST_Centroid(precincts.the_geom));"

cp shapefiles/precincts_pvi_2002/precincts_pvi_2002.prj shapefiles/pvi_2002_leg/pvi_2002_leg.prj
cp shapefiles/precincts_pvi_2002/precincts_pvi_2002.shp shapefiles/pvi_2002_leg/pvi_2002_leg.shp
cp shapefiles/precincts_pvi_2002/precincts_pvi_2002.shx shapefiles/pvi_2002_leg/pvi_2002_leg.shx

cp shapefiles/precincts_pvi_2012/precincts_pvi_2012.prj shapefiles/pvi_2012_leg/pvi_2012_leg.prj
cp shapefiles/precincts_pvi_2012/precincts_pvi_2012.shp shapefiles/pvi_2012_leg/pvi_2012_leg.shp
cp shapefiles/precincts_pvi_2012/precincts_pvi_2012.shx shapefiles/pvi_2012_leg/pvi_2012_leg.shx

python dbf_to_csv.py -f shapefiles/precincts_pvi_2002/precincts_pvi_2002.dbf -o shapefiles/precincts_pvi_2002/precincts_pvi_2002.csv

python dbf_to_csv.py -f shapefiles/precincts_pvi_2012/precincts_pvi_2012.dbf -o shapefiles/precincts_pvi_2012/precincts_pvi_2012.csv

python pivot.py -f shapefiles/precincts_pvi_2002/precincts_pvi_2002.csv -o shapefiles/pvi_2002_leg/pvi_2002_leg

python pivot.py -f shapefiles/precincts_pvi_2012/precincts_pvi_2012.csv -o shapefiles/pvi_2012_leg/pvi_2012_leg

# TODO This process is not sustainable
# open shapefiles/precincts_pvi/20{02,12}/precincts_pvi_20{02,12}.shp with Excel, pivot table to find totals, calculate pvi using formula, copy these results into .csv
# open this csv in OpenOffice, save as shapefiles/pvi_20{02,12}_leg/pvi_20{02,12}_leg.dbf
# copy rest of shapefile files into this dir
